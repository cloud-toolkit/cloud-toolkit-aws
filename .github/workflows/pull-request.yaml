name: pull-request

on:
  pull_request: {}

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: NPM ci
        run: npm ci
        working-directory: provider/cmd/pulumi-resource-cloud-toolkit-aws
      - name: NPM test
        run: npm run test
        working-directory: provider/cmd/pulumi-resource-cloud-toolkit-aws
  publish_sdk:
    name: publish_sdk
    runs-on: ubuntu-latest
    needs:
      - test
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v2
      - name: Unshallow clone for tags
        run: git fetch --prune --unshallow --tags
      - name: Setup Node
        uses: actions/setup-node@v1
        with:
          node-version: 16.x
      - name: Install pulumictl
        uses: jaxxstorm/action-install-gh-release@v1.5.0
        with:
          repo: pulumi/pulumictl

      - name: Install Pulumi CLI
        uses: pulumi/action-install-pulumi-cli@v1.0.1
      - name: Build SDKs
        run: make build_sdk
  publish_provider:
    name: publish_provider
    runs-on: macos-12
    needs:
      - test
    env:
      bucket: s3://cloud-toolkit-dev
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v2
      - name: Unshallow clone for tags
        run: git fetch --prune --unshallow --tags
      - name: Setup Node
        uses: actions/setup-node@v1
        with:
          node-version: 16.x
      - name: Install pulumictl
        uses: jaxxstorm/action-install-gh-release@v1.5.0
        with:
          repo: pulumi/pulumictl
      - name: Install Pulumi CLI
        uses: pulumi/action-install-pulumi-cli@v1.0.1
      - name: Create Provider Binaries
        run: make dist
